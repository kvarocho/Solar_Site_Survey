<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Solar Site Survey - Indigenized Energy</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root{
      --primary:#D2691E;
      --primary-dark:#8B4513;
      --primary-light:#DEB887;
      --success:#2E7D32;
      --warning:#F57C00;
      --text-primary:#1A1A1A;
      --text-secondary:#666666;
    }

    body{
      font-family:'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      position: relative;
      min-height:100vh;
      color:var(--text-primary);
    }

    /* Mobile-friendly background */
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('images/Buff_Back.jpg') center center no-repeat;
      background-size: cover;
      z-index: -2;
    }

    /* Overlay for readability */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 248, 225, 0.75);
      z-index: -1;
    }

    /* Header */
   .app-header{
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      padding:20px 0;
      position:sticky;
      top:0;
      z-index:100;
    }

    .header-content{
      max-width:1200px;
      margin:0 auto;
      padding:0 24px;
      display:flex;
      align-items:center;
      gap:16px;
    }

    .logo-icon{
      width:48px;
      height:48px;
      background:linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:24px;
    }

    .header-title h1{
      font-size:24px;
      font-weight:700;
      color:white;
      line-height:1.2;
    }

    .header-title .subtitle{
      font-size:14px;
      color:var(--text-secondary);
      font-weight:500;
    }

    /* Container */
    .container{
      max-width:1200px;
      margin:32px auto;
      padding:0 24px 40px;
    }

    /* Progress */
    .progress-container{
      background:rgba(255, 255, 255, 0.80);
      border-radius:16px;
      padding:24px;
      margin-bottom:32px;
      box-shadow:0 4px 16px rgba(0,0,0,0.12);
    }

    .progress-label{
      font-size:14px;
      font-weight:600;
      color:var(--text-secondary);
      margin-bottom:12px;
      display:flex;
      justify-content:space-between;
    }

    .progress-percent{
      font-size:20px;
      font-weight:700;
      color:var(--primary);
    }

    .progress-bar{
      height:12px;
      background:#F5F5F5;
      border-radius:12px;
      overflow:hidden;
    }

    .progress-fill{
      height:100%;
      background:linear-gradient(90deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius:12px;
      transition:width 0.3s ease;
    }

    /* Sections - Enhanced shadow for visibility against background */
    .section{
      background:rgba(255, 255, 255, 0.80);
      border-radius:16px;
      margin-bottom:24px;
      box-shadow:0 6px 20px rgba(0,0,0,0.15);
      overflow:hidden;
    }

    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:24px;
      cursor:pointer;
      background:linear-gradient(to right, #FAFAFA 0%, #FFFFFF 100%);
      border-bottom:2px solid #E0E0E0;
    }

    .section-header:hover{ background:#F5F5F5; }

    .section-title{
      font-size:20px;
      color:var(--text-primary);
      font-weight:700;
    }

    .section-status{
      background:var(--warning);
      color:white;
      padding:8px 20px;
      border-radius:24px;
      font-size:13px;
      font-weight:600;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
    }

    .section-status.complete{ background:var(--success); }

    .section-content{
      display:none;
      padding:32px 24px;
    }

    .section-content.active{ display:block; }

    /* Forms */
    .form-group{ margin-bottom:28px; }

    label{
      display:block;
      font-weight:600;
      margin-bottom:10px;
      color:var(--text-primary);
      font-size:15px;
    }

    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      padding:14px 16px;
      border:2px solid #E0E0E0;
      border-radius:12px;
      font-size:15px;
      font-family:'Inter', sans-serif;
      transition:all 0.2s;
      background:white;
    }

    input:focus, textarea:focus, select:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 4px rgba(210,105,30,0.1);
    }

    textarea{ min-height:100px; resize:vertical; }

    small{
      display:block;
      margin-top:8px;
      color:var(--text-secondary);
      font-size:13px;
    }

    /* Buttons */
    .photo-btn{
      background:linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color:white;
      border:none;
      padding:14px 24px;
      border-radius:12px;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      font-family:'Inter', sans-serif;
    }

    .photo-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 16px rgba(0,0,0,0.12);
    }

    /* Info Boxes */
    .info-box{
      background:linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
      border-left:4px solid var(--primary);
      padding:20px;
      border-radius:12px;
      margin-bottom:24px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
    }

    .info-box strong{
      display:block;
      color:var(--primary-dark);
      font-size:16px;
      margin-bottom:12px;
      font-weight:700;
    }

    .status-good{ color:var(--success); font-weight:600; }
    .status-warning{ color:var(--warning); font-weight:600; }
    .status-bad{ color:#C62828; font-weight:600; }

    /* Checkboxes */
    .checkbox-group{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap:16px;
      margin-top:12px;
    }

    .checkbox-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px;
      background:#FAFAFA;
      border-radius:8px;
    }

    .checkbox-item input{
      width:20px;
      height:20px;
      cursor:pointer;
    }

    .checkbox-item label{
      margin:0;
      font-weight:500;
      cursor:pointer;
      font-size:14px;
    }

    /* Photo Gallery */
    .photo-gallery{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap:16px;
      margin-top:16px;
    }

    .photo-item{
      position:relative;
      aspect-ratio:1;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 4px 16px rgba(0,0,0,0.12);
    }

    .photo-item img{
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .photo-delete{
      position:absolute;
      top:8px;
      right:8px;
      background:rgba(198,40,40,0.9);
      color:white;
      border:none;
      width:32px;
      height:32px;
      border-radius:50%;
      font-size:20px;
      cursor:pointer;
    }

    /* Action Buttons */
    .action-buttons{
      display:flex;
      gap:15px;
      margin-top:30px;
      flex-wrap:wrap;
    }

    .btn{
      padding:15px 30px;
      border:none;
      border-radius:10px;
      font-size:1.05em;
      font-weight:bold;
      cursor:pointer;
      transition:transform 0.2s;
    }

    .btn:active{ transform:scale(0.95); }

    .btn-primary{ background:#6b8e23; color:white; }
    .btn-secondary{ background:#d2691e; color:white; }
    .btn-danger{ background:#c84630; color:white; }

    /* Mobile */
    @media (max-width:768px){
      .container{ padding:0 16px 32px; margin:16px auto; }
      .header-content{ padding:0 16px; }
      .section-header, .section-content{ padding:20px 16px; }
      .checkbox-group{ grid-template-columns:1fr; }
    }

    input[type="file"]{ display:none; }
  .header-logo {
    margin-left: auto;
    height: 44px;
    width: auto;
    object-fit: contain;
}

@media (max-width: 768px) {
    .header-logo {
        height: 32px;
    }
}
/* Safety Disclaimer Modal */
    .safety-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .safety-modal-overlay.hidden { display: none; }
    .safety-modal {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .safety-modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    .safety-modal-header h2 {
      color: var(--warning);
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }
    .safety-modal-content {
      font-size: 16px;
      line-height: 1.6;
      color: var(--text-primary);
      margin-bottom: 24px;
    }
    .safety-modal-content p { margin-bottom: 16px; }
    .safety-modal-content ul {
      list-style: none;
      padding-left: 0;
      margin: 12px 0;
    }
    .safety-modal-content ul li {
      padding: 8px 0;
      padding-left: 28px;
      position: relative;
    }
    .safety-modal-content ul li:before {
      content: "‚úó";
      position: absolute;
      left: 0;
      color: #C62828;
      font-weight: bold;
      font-size: 18px;
    }
    .safety-modal-agree {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #FFF8E1;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 2px solid var(--warning);
    }
    .safety-modal-agree input[type="checkbox"] {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    .safety-modal-agree label {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      margin: 0;
    }
    .safety-modal-button {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }
    .safety-modal-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .safety-modal-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    /* Safety Warning Bar (minimized) */
    .safety-warning-bar {
      background: linear-gradient(135deg, var(--warning) 0%, #E65100 100%);
      color: white;
      padding: 12px 24px;
      display: none;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      position: sticky;
      top: 0;
      z-index: 99;
      cursor: pointer;
      transition: all 0.2s;
    }
    .safety-warning-bar:hover {
      background: linear-gradient(135deg, #E65100 0%, var(--warning) 100%);
    }
    .safety-warning-bar.visible { display: flex; }
    .safety-warning-text {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
    }
    .safety-warning-icon { font-size: 18px; }
    .safety-warning-link {
      font-size: 13px;
      text-decoration: underline;
      opacity: 0.9;
    }
    @media (max-width:768px){
      .safety-modal { padding: 24px; }
      .safety-warning-bar {
        flex-direction: column;
        gap: 8px;
        text-align: center;
      }
    }
</style>
</head>

<body>
  <!-- Safety Disclaimer Modal -->
  <div class="safety-modal-overlay" id="safetyModal">
    <div class="safety-modal">
      <div class="safety-modal-header">
        <span style="font-size: 32px;">‚ö†Ô∏è</span>
        <h2>SAFETY DISCLAIMER</h2>
      </div>
      
      <div class="safety-modal-content">
        <p><strong>This survey form can be completed safely from the ground and outside electrical panels.</strong></p>
        
        <p><strong>DO NOT:</strong></p>
        <ul>
          <li>Open electrical panels unless you are a licensed electrician</li>
          <li>Climb on roofs unless you are trained and have proper fall protection PPE</li>
          <li>Put yourself in any dangerous situation to complete this form</li>
        </ul>
        
        <p style="margin-top: 20px;"><strong>You are responsible for your own safety. Indigenized Energy is not liable for any injuries that occur during site surveys.</strong></p>
      </div>

      <div class="safety-modal-agree">
        <input type="checkbox" id="safetyAgree" />
        <label for="safetyAgree">I understand and will work safely</label>
      </div>

      <button class="safety-modal-button" id="safetyProceed" disabled>
        Proceed to Survey Form
      </button>
    </div>
  </div>

  <!-- Safety Warning Bar (Minimized) -->
  <div class="safety-warning-bar" id="safetyBar" onclick="reopenSafetyModal()">
    <div class="safety-warning-text">
      <span class="safety-warning-icon">‚ö†Ô∏è</span>
      <span>Safety Acknowledged</span>
    </div>
    <span class="safety-warning-link">Click to review</span>
  </div>
  <!-- Professional Header -->
  <div class="app-header">
    <div class="header-content">
      <div style="display:flex; align-items:center; gap:16px;">
    <div class="logo-icon">‚òÄÔ∏è</div>
    <div class="header-title">
        <h1>Solar Site Survey</h1>
        <span class="subtitle">Indigenized Energy</span>
    </div>
</div>

<img
    src="images/ie_logo.png"
    alt="Indigenized Energy logo"
    class="header-logo"
/>

    </div>
  </div>

  <div class="container">
    <!-- Professional Progress Bar -->
    <div class="progress-container">
      <div class="progress-label">
        <span>Survey Progress</span>
        <span class="progress-percent" id="progress-text">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width:0%;"></div>
      </div>
    </div>

    <!-- Connectivity + Data Handling (ADDED) -->
    <div class="progress-container" id="connectivity-container" style="margin-top:-12px;">
      <div class="progress-label" style="align-items:center;">
        <span>
          <strong>Connectivity:</strong>
          <span id="connectivity-status" class="status-warning">Checking‚Ä¶</span>
          <span id="connectivity-note" style="margin-left:10px; color: var(--text-secondary); font-weight: 500;"></span>
        </span>
        <span style="font-size:13px; color: var(--text-secondary); font-weight:600;">Offline-first ‚úÖ</span>
      </div>

      <div class="info-box" style="margin-bottom:0;">
        <strong>Data Handling</strong>
        This form does not send data anywhere by itself. Entries and photos stay on this device unless you download/share the report.
        If this device is shared, clear saved data when you‚Äôre done.
      </div>
    </div>

    <!-- Site Information -->
    <div class="section">
      <div class="section-header" onclick="toggleSection('site-info')">
        <div class="section-title">üìã Site Information</div>
        <div class="section-status" id="status-site-info">Incomplete</div>
      </div>
      <div class="section-content active" id="content-site-info">
        <div class="form-group">
          <label>Site Name *</label>
          <input type="text" id="site-name" placeholder="Enter site/project name">
        </div>

        <div class="form-group">
          <label>GPS Coordinates</label>
          <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" id="gps-coords" placeholder="Will be captured automatically" readonly style="flex:1;">
            <button class="photo-btn" onclick="captureGPS()" style="margin:0;">üìç Get Location</button>
          </div>
        </div>

        <div class="form-group">
          <label>Tribal Affiliation *</label>
          <select id="tribal-affiliation">
            <option value="">Select tribe</option>
            <option value="Yankton Sioux Tribe">Yankton Sioux Tribe</option>
            <option value="Turtle Mountain Band of Chippewa">Turtle Mountain Band of Chippewa</option>
            <option value="Spirit Lake Tribe">Spirit Lake Tribe</option>
            <option value="Rosebud Sioux Tribe">Rosebud Sioux Tribe</option>
            <option value="Oglala Sioux Tribe">Oglala Sioux Tribe</option>
            <option value="Northern Cheyenne Tribe">Northern Cheyenne Tribe</option>
            <option value="Northern Arapaho Tribe">Northern Arapaho Tribe</option>
            <option value="MHA Nation (Mandan, Hidatsa & Arikara)">MHA Nation (Mandan, Hidatsa & Arikara)</option>
            <option value="Menominee Indian Tribe of Wisconsin">Menominee Indian Tribe of Wisconsin</option>
            <option value="Sisseton Wahpeton Oyate (Lake Traverse)">Sisseton Wahpeton Oyate (Lake Traverse)</option>
            <option value="Flandreau Santee Sioux Tribe">Flandreau Santee Sioux Tribe</option>
            <option value="Chippewa Cree Tribe">Chippewa Cree Tribe</option>
            <option value="Blackfeet Nation">Blackfeet Nation</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label>Site Address *</label>
          <input type="text" id="site-address" placeholder="Street address">
        </div>

        <div class="form-group">
          <label>City, State, ZIP</label>
          <input type="text" id="city-state-zip" placeholder="City, State, ZIP">
        </div>

        <div class="form-group">
          <label>Survey Date *</label>
          <input type="text" id="survey-date" readonly>
        </div>

        <div class="form-group">
          <label>Surveyor Name *</label>
          <input type="text" id="surveyor-name" placeholder="Your name">
        </div>
      </div>
    </div>

    <!-- Roof/Mounting Information -->
    <div class="section">
      <div class="section-header" onclick="toggleSection('roof-info')">
        <div class="section-title">üè† Roof & Mounting</div>
        <div class="section-status" id="status-roof-info">Incomplete</div>
      </div>
      <div class="section-content" id="content-roof-info">

        <div class="form-group">
          <label>Installation Type *</label>
          <div class="checkbox-group" style="display:block;">
            <div class="checkbox-item">
              <input type="checkbox" id="mount-roof" onchange="toggleMountSection('roof')">
              <label for="mount-roof">Roof Mount</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="mount-ground" onchange="toggleMountSection('ground')">
              <label for="mount-ground">Ground Mount</label>
            </div>
          </div>
          <small style="color:#666;">Check one or both if surveying multiple options</small>
        </div>

        <!-- General Roof Info -->
        <div id="roof-general-info" style="display:none;">
          <div class="form-group">
            <label>Roof Type *</label>
            <select id="roof-type">
              <option value="">Select roof type</option>
              <option value="asphalt-shingle">Asphalt Shingle</option>
              <option value="metal">Metal</option>
              <option value="tile">Tile</option>
              <option value="flat">Flat/Built-up</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label>Roof Condition (Overall)</label>
            <select id="roof-condition">
              <option value="">Select condition</option>
              <option value="excellent">Excellent</option>
              <option value="good">Good</option>
              <option value="fair">Fair</option>
              <option value="poor">Poor - Needs Replacement</option>
            </select>
          </div>

          <div class="form-group">
            <label>Estimated Roof Age (years)</label>
            <input type="number" id="roof-age" placeholder="Years" min="0">
          </div>
        </div>

        <!-- Roof Mount Section -->
        <div id="roof-mount-section" style="display:none; border-left:3px solid #D2691E; padding-left:15px; margin-top:15px;">
          <h3 style="color:#8B4513; margin-bottom:15px;">Roof Mounting Planes</h3>

          <div class="form-group">
            <label>Number of Roof Mounting Planes *</label>
            <select id="num-roof-planes" onchange="generateRoofPlanes()">
              <option value="">Select number</option>
              <option value="1">1 Mounting Plane</option>
              <option value="2">2 Mounting Planes</option>
              <option value="3">3 Mounting Planes</option>
              <option value="4">4 Mounting Planes</option>
            </select>
          </div>

          <div id="roof-planes-container"></div>

          <div class="form-group">
            <label>Roof Mounting Plane Photos</label>
            <button class="photo-btn" onclick="capturePhoto('roof-mounting')">üì∑ Take Photo</button>
            <input type="file" id="roof-mounting-input" accept="image/*" capture="environment" onchange="handlePhotoUpload(event, 'roof-mounting')">
            <div class="photo-gallery" id="roof-mounting-gallery"></div>
          </div>
        </div>

        <!-- Ground Mount Section -->
        <div id="ground-mount-section" style="display:none; border-left:3px solid #228B22; padding-left:15px; margin-top:15px;">
          <h3 style="color:#006400; margin-bottom:15px;">Ground Mount Area</h3>

          <div class="form-group">
            <label>Ground Mount Area Size</label>
            <input type="text" id="ground-size" placeholder="e.g., 40ft x 30ft or 1200 sq ft">
          </div>

          <div class="form-group">
            <label>Ground Mount Direction/Orientation</label>
            <select id="ground-direction">
              <option value="">Select direction</option>
              <option value="south">South (Best)</option>
              <option value="southwest">Southwest (Good)</option>
              <option value="southeast">Southeast (Good)</option>
              <option value="east">East (OK)</option>
              <option value="west">West (OK)</option>
              <option value="north">North (Avoid)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Ground Mount Area Photos</label>
            <button class="photo-btn" onclick="capturePhoto('ground-mount')">üì∑ Take Photo</button>
            <input type="file" id="ground-mount-input" accept="image/*" capture="environment" onchange="handlePhotoUpload(event, 'ground-mount')">
            <div class="photo-gallery" id="ground-mount-gallery"></div>
          </div>

          <div class="form-group">
            <label>Ground Mount Notes</label>
            <textarea id="ground-notes" placeholder="Notes about ground mount area..."></textarea>
          </div>
        </div>

        <div class="form-group">
          <label>Roof Obstructions</label>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="obstruction-chimneys">
              <label for="obstruction-chimneys">Chimneys</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="obstruction-vents">
              <label for="obstruction-vents">Vents</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="obstruction-skylights">
              <label for="obstruction-skylights">Skylights</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="obstruction-trees">
              <label for="obstruction-trees">Trees/Shade</label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="roof-notes" placeholder="Additional roof observations..."></textarea>
        </div>
      </div>
    </div>

    <!-- Electrical Service -->
    <div class="section">
      <div class="section-header" onclick="toggleSection('electrical-info')">
        <div class="section-title">‚ö° Electrical Service</div>
        <div class="section-status" id="status-electrical-info">Incomplete</div>
      </div>
      <div class="section-content" id="content-electrical-info">
        <div class="form-group">
          <label>Main Service Panel Photos *</label>
          <button class="photo-btn" onclick="capturePhoto('main-panel')">üì∑ Take Photo</button>
          <input type="file" id="main-panel-input" accept="image/*" capture="environment" onchange="handlePhotoUpload(event, 'main-panel')">
          <div class="photo-gallery" id="main-panel-gallery"></div>
        </div>

        <div class="form-group">
          <label>Electrical Panel Cover/Label Photo</label>
          <button class="photo-btn" onclick="capturePhoto('panel-label')">üì∑ Take Photo of Panel Label</button>
          <input type="file" id="panel-label-input" accept="image/*" capture="environment" onchange="handlePhotoUpload(event, 'panel-label')">
          <div class="photo-gallery" id="panel-label-gallery"></div>
          <small style="color:#666;">Close-up photo of the panel label showing ratings</small>
        </div>

        <div class="form-group">
          <label>Service Panel Amperage (on Panel Label) *</label>
          <select id="panel-amperage">
            <option value="">Select amperage</option>
            <option value="100">100 Amp</option>
            <option value="125">125 Amp</option>
            <option value="150">150 Amp</option>
            <option value="200">200 Amp</option>
            <option value="400">400 Amp</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label>Main Breaker Size (on Main Breaker - Amps)</label>
          <input type="number" id="main-breaker" placeholder="Amps" min="0">
        </div>

        <div class="form-group">
          <label>Available Breaker Spaces</label>
          <input type="number" id="available-spaces" placeholder="Number of open spaces" min="0">
        </div>

        <div class="form-group">
          <label>Grounding System Photos</label>
          <button class="photo-btn" onclick="capturePhoto('grounding')">üì∑ Take Photo</button>
          <input type="file" id="grounding-input" accept="image/*" capture="environment" onchange="handlePhotoUpload(event, 'grounding')">
          <div class="photo-gallery" id="grounding-gallery"></div>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="electrical-notes" placeholder="Electrical observations, upgrades needed, etc..."></textarea>
        </div>
      </div>
    </div>

    <!-- Shading Analysis -->
    <div class="section">
      <div class="section-header" onclick="toggleSection('shading-info')">
        <div class="section-title">üå§Ô∏è Shading Analysis</div>
        <div class="section-status" id="status-shading-info">Incomplete</div>
      </div>
      <div class="section-content" id="content-shading-info">
        <div class="form-group">
          <label>Shading Photos (different angles) *</label>
          <button class="photo-btn" onclick="capturePhoto('shading')">üì∑ Take Photo</button>
          <input type="file" id="shading-input" accept="image/*" capture="environment" onchange="handlePhotoUpload(event, 'shading')">
          <div class="photo-gallery" id="shading-gallery"></div>
        </div>

        <div class="form-group">
          <label>Estimated Shading (%)</label>
          <select id="shading-percent">
            <option value="">Select shading level</option>
            <option value="0-10">0-10% (Excellent)</option>
            <option value="10-25">10-25% (Good)</option>
            <option value="25-50">25-50% (Fair)</option>
            <option value="50+">50%+ (Poor)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Shading Sources</label>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="shade-trees">
              <label for="shade-trees">Trees</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="shade-buildings">
              <label for="shade-buildings">Buildings</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="shade-mountains">
              <label for="shade-mountains">Mountains/Terrain</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="shade-none">
              <label for="shade-none">No Shading</label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="shading-notes" placeholder="Shading observations..."></textarea>
        </div>
      </div>
    </div>

    <!-- System Recommendations -->
    <div class="section">
      <div class="section-header" onclick="toggleSection('system-rec')">
        <div class="section-title">‚ö° System Recommendations</div>
        <div class="section-status" id="status-system-rec">Optional</div>
      </div>
      <div class="section-content" id="content-system-rec">
        <div class="form-group">
          <label>Recommended Solar System Size (kW)</label>
          <div style="display:flex; gap:10px; align-items:center;">
            <button class="photo-btn" onclick="calculateSystemSize()" style="margin:0;">üî¢ Auto-Calculate</button>
            <input type="number" step="0.5" id="system-size" placeholder="Enter or calculate system size (kW)" style="flex:1;" min="0">
          </div>
          <small style="color:#666;">Based on panel size and typical usage</small>
        </div>

        <div class="form-group">
          <label>Battery Storage Recommended?</label>
          <select id="battery-included">
            <option value="">Select option</option>
            <option value="yes">Yes - Include Battery</option>
            <option value="no">No Battery</option>
          </select>
        </div>

        <div class="form-group" id="battery-size-group" style="display:none;">
          <label>Battery Size (kWh)</label>
          <select id="battery-size">
            <option value="">Select battery size</option>
            <option value="5">5 kWh</option>
            <option value="7">7 kWh</option>
            <option value="10">10 kWh (Standard)</option>
            <option value="13">13 kWh</option>
            <option value="15">15 kWh</option>
            <option value="20">20 kWh (Large)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Installation Notes</label>
          <textarea id="system-notes" placeholder="Any special considerations for installation, equipment recommendations, etc..."></textarea>
        </div>
      </div>
    </div>

    <!-- Additional Site Photos -->
    <div class="section">
      <div class="section-header" onclick="toggleSection('additional-photos')">
        <div class="section-title">üì∏ Additional Photos</div>
        <div class="section-status" id="status-additional-photos">Optional</div>
      </div>
      <div class="section-content" id="content-additional-photos">
        <div class="form-group">
          <label>Attic Access</label>
          <button class="photo-btn" onclick="capturePhoto('attic')">üì∑ Take Photo</button>
          <input type="file" id="attic-input" accept="image/*" capture="environment" onchange="handlePhotoUpload(event, 'attic')">
          <div class="photo-gallery" id="attic-gallery"></div>
        </div>

        <div class="form-group">
          <label>Meter Location</label>
          <button class="photo-btn" onclick="capturePhoto('meter')">üì∑ Take Photo</button>
          <input type="file" id="meter-input" accept="image/*" capture="environment" onchange="handlePhotoUpload(event, 'meter')">
          <div class="photo-gallery" id="meter-gallery"></div>
        </div>

        <div class="form-group">
          <label>Property Overview</label>
          <button class="photo-btn" onclick="capturePhoto('overview')">üì∑ Take Photo</button>
          <input type="file" id="overview-input" accept="image/*" capture="environment" onchange="handlePhotoUpload(event, 'overview')">
          <div class="photo-gallery" id="overview-gallery"></div>
        </div>
      </div>
    </div>

    <!-- Final Notes -->
    <div class="section">
      <div class="section-header" onclick="toggleSection('final-notes')">
        <div class="section-title">üìù Survey Summary</div>
        <div class="section-status" id="status-final-notes">Optional</div>
      </div>
      <div class="section-content" id="content-final-notes">
        <div class="form-group">
          <label>Overall Site Assessment</label>
          <textarea id="overall-assessment" placeholder="Summary of findings, recommendations, concerns..."></textarea>
        </div>

        <div class="form-group">
          <label>Recommended System Size (kW)</label>
          <input type="number" step="0.1" id="recommended-size" placeholder="kW" min="0">
        </div>

        <div class="form-group">
          <label>Special Considerations</label>
          <textarea id="special-considerations" placeholder="Any special requirements, challenges, or opportunities..."></textarea>
        </div>
      </div>
    </div>

    <!-- Upload Prep (ADDED) -->
    <div class="section">
      <div class="section-header" onclick="toggleSection('upload-prep')">
        <div class="section-title">‚òÅÔ∏è Upload Prep</div>
        <div class="section-status" id="status-upload-prep">Optional</div>
      </div>

      <div class="section-content" id="content-upload-prep">
        <div class="info-box">
          <strong>Ready for Upload</strong>
          Use this when the survey is complete and you‚Äôre ready to send/store it in your official system.
        </div>

        <div class="form-group">
          <label>Mark as Ready for Upload</label>
          <div class="checkbox-group" style="display:block;">
            <div class="checkbox-item">
              <input type="checkbox" id="ready-for-upload">
              <label for="ready-for-upload">Survey packet is complete and ready to upload</label>
            </div>
          </div>
          <small id="ready-timestamp" style="color: var(--text-secondary);"></small>
        </div>

        <div class="form-group">
          <label>Upload Notes</label>
          <textarea id="upload-notes" placeholder="Anything the office should know (missing photo, follow-up needed, access issue, etc.)..."></textarea>
        </div>
      </div>
    </div>

    <!-- Clear-after-export toggle (ADDED) -->
    <div style="margin:18px 0; display:flex; justify-content:center;">
      <div class="checkbox-item" style="max-width:680px; width:100%; background:#FAFAFA;">
        <input type="checkbox" id="clear-after-export" checked>
        <label for="clear-after-export" style="margin:0;">Clear saved progress on this device after exporting</label>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-primary" onclick="generateReport()">üìÑ Generate Report</button>
      <button class="btn btn-secondary" onclick="saveProgress()">üíæ Save Progress</button>
      <button class="btn btn-danger" onclick="clearSurvey()">üóëÔ∏è Clear Survey</button>
    </div>
  </div>

 <script>
  // ============================================
// Safety Disclaimer Logic
// ============================================
let safetyAcknowledged = false;
let safetyAcknowledgedTimestamp = null;

function checkSafetyAcknowledgement() {
  // Don't check localStorage - always show the disclaimer
  // Modal stays visible on every page load
}

document.getElementById('safetyAgree').addEventListener('change', function() {
  document.getElementById('safetyProceed').disabled = !this.checked;
});

document.getElementById('safetyProceed').addEventListener('click', function() {
  safetyAcknowledgedTimestamp = new Date().toISOString();
  safetyAcknowledged = true;
  
  // Don't save to localStorage - they'll need to agree every time
  
  document.getElementById('safetyModal').classList.add('hidden');
  document.getElementById('safetyBar').classList.add('visible');
});

function reopenSafetyModal() {
  document.getElementById('safetyModal').classList.remove('hidden');
}

// Check on load
checkSafetyAcknowledgement();
// ============================================
// IndexedDB Helper (replaces localStorage)
// ============================================
const DB_NAME = 'SolarSurvey_Database';
const DB_VERSION = 1;
const STORE_NAME = 'progress';

let db = null;

// Initialize IndexedDB
function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = () => reject(request.error);
    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
      }
    };
  });
}

// Save to IndexedDB
async function saveToIndexedDB(key, value) {
  if (!db) await initDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.put({ id: key, data: value });
    request.onsuccess = () => resolve(true);
    request.onerror = () => reject(request.error);
  });
}

// Load from IndexedDB
async function loadFromIndexedDB(key) {
  if (!db) await initDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.get(key);
    request.onsuccess = () => resolve(request.result ? request.result.data : null);
    request.onerror = () => reject(request.error);
  });
}

// Delete from IndexedDB
async function deleteFromIndexedDB(key) {
  if (!db) await initDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.delete(key);
    request.onsuccess = () => resolve(true);
    request.onerror = () => reject(request.error);
  });
}

// ============================================
// Helper Functions
// ============================================

// Count total photos
function getTotalPhotoCount() {
  let total = 0;
  for (let type in photos) {
    total += (photos[type] || []).length;
  }
  return total;
}

// Update connectivity status with photo warnings
function updateConnectivityStatus() {
  const statusEl = document.getElementById('connectivity-status');
  const noteEl = document.getElementById('connectivity-note');
  if (!statusEl || !noteEl) return;

  const online = navigator.onLine;
  const photoCount = getTotalPhotoCount();
  
  // Connectivity status
  statusEl.textContent = online ? 'Online' : 'Offline';
  statusEl.className = online ? 'status-good' : 'status-warning';
  
  // Smart warnings based on photo count
  if (photoCount === 0) {
    noteEl.innerHTML = online
      ? 'You can work offline. Downloads work either way.'
      : 'Offline mode active. Data stays on-device until export.';
  } else if (photoCount < 20) {
    noteEl.innerHTML = `<strong>${photoCount} photo${photoCount !== 1 ? 's' : ''} captured.</strong> Looking good! üëç`;
  } else if (photoCount < 30) {
    noteEl.innerHTML = `<strong style="color: var(--warning);">${photoCount} photos captured.</strong> ‚ö†Ô∏è Consider exporting soon.`;
  } else {
    noteEl.innerHTML = `<strong style="color: #C62828;">${photoCount} photos!</strong> üö® Export report now to avoid data loss.`;
  }
}

// ============================================
// Initialize on page load
// ============================================
window.addEventListener('load', async function() {
  // Initialize IndexedDB
  await initDB();
  
  // Initialize survey date
  document.getElementById('survey-date').value = new Date().toLocaleDateString();
  
  updateConnectivityStatus();
  
  // Ready-for-upload timestamp
  const readyBox = document.getElementById('ready-for-upload');
  const readyTs = document.getElementById('ready-timestamp');
  if (readyBox && readyTs) {
    const savedReady = await loadFromIndexedDB('solarSurveyReadyTimestamp');
    if (savedReady) {
      readyTs.textContent = 'Marked ready on: ' + new Date(savedReady).toLocaleString();
      readyBox.checked = true;
    }
    readyBox.addEventListener('change', async () => {
      if (readyBox.checked) {
        const ts = new Date().toISOString();
        await saveToIndexedDB('solarSurveyReadyTimestamp', ts);
        readyTs.textContent = 'Marked ready on: ' + new Date(ts).toLocaleString();
      } else {
        await deleteFromIndexedDB('solarSurveyReadyTimestamp');
        readyTs.textContent = '';
      }
    });
  }
  
  // Try to load saved progress
  const saved = await loadFromIndexedDB('solarSurvey');
  if (saved && confirm('Found saved progress. Would you like to restore it?')) {
    await loadProgress();
  }
  
  updateProgress();
});

// Online/offline listeners
window.addEventListener('online', updateConnectivityStatus);
window.addEventListener('offline', updateConnectivityStatus);

// ============================================
// Photo Storage
// ============================================
const photos = {
  'roof-mounting': [],
  'ground-mount': [],
  'main-panel': [],
  'panel-label': [],
  'grounding': [],
  'shading': [],
  'attic': [],
  'meter': [],
  'overview': []
};

// ============================================
// GPS Capture
// ============================================
function captureGPS() {
  if (navigator.geolocation) {
    document.getElementById('gps-coords').value = 'Getting location...';
    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude.toFixed(6);
        const lon = position.coords.longitude.toFixed(6);
        document.getElementById('gps-coords').value = `${lat}, ${lon}`;
        updateProgress();
      },
      function() {
        alert('Unable to get GPS location. Please enable location services.');
        document.getElementById('gps-coords').value = '';
      }
    );
  } else {
    alert('GPS not supported on this device');
  }
}

// ============================================
// System Size Calculator
// ============================================
function calculateSystemSize() {
  const panelAmps = parseInt(document.getElementById('panel-amperage').value) || 0;
  if (panelAmps === 0) {
    alert('Please select Panel Amperage first to calculate system size');
    return;
  }

  let baseSize = 0;
  if (panelAmps <= 100) baseSize = 4.0;
  else if (panelAmps <= 150) baseSize = 6.0;
  else if (panelAmps <= 200) baseSize = 8.0;
  else baseSize = 12.0;

  let totalSpace = 0;

  const numRoofPlanes = parseInt(document.getElementById('num-roof-planes')?.value) || 0;
  if (numRoofPlanes > 0) {
    for (let i = 1; i <= numRoofPlanes; i++) {
      const sizeInput = document.getElementById(`plane-${i}-size`)?.value || '';
      const direction = document.getElementById(`plane-${i}-direction`)?.value || '';

      let sqft = 0;
      if (sizeInput.includes('x')) {
        const parts = sizeInput.toLowerCase().replace(/ft/g, '').split('x');
        if (parts.length === 2) {
          const width = parseFloat(parts[0].trim()) || 0;
          const length = parseFloat(parts[1].trim()) || 0;
          sqft = width * length;
        }
      } else {
        sqft = parseFloat(sizeInput.replace(/[^0-9.]/g, '')) || 0;
      }

      let dirMultiplier = 1.0;
      if (direction === 'south') dirMultiplier = 1.0;
      else if (direction === 'southwest' || direction === 'southeast') dirMultiplier = 0.92;
      else if (direction === 'east' || direction === 'west') dirMultiplier = 0.78;
      else if (direction === 'north') dirMultiplier = 0.5;

      totalSpace += sqft * dirMultiplier;
    }
  }

  const groundSize = document.getElementById('ground-size')?.value || '';
  if (groundSize) {
    let groundSqft = 0;
    if (groundSize.includes('x')) {
      const parts = groundSize.toLowerCase().replace(/ft/g, '').split('x');
      if (parts.length === 2) {
        const width = parseFloat(parts[0].trim()) || 0;
        const length = parseFloat(parts[1].trim()) || 0;
        groundSqft = width * length;
      }
    } else {
      groundSqft = parseFloat(groundSize.replace(/[^0-9.]/g, '')) || 0;
    }

    const groundDir = document.getElementById('ground-direction')?.value || '';
    let groundDirMult = 1.0;
    if (groundDir === 'south') groundDirMult = 1.0;
    else if (groundDir === 'southwest' || groundDir === 'southeast') groundDirMult = 0.92;
    else if (groundDir === 'east' || groundDir === 'west') groundDirMult = 0.78;
    else if (groundDir === 'north') groundDirMult = 0.5;

    totalSpace += groundSqft * groundDirMult;
  }

  const spaceBasedSize = totalSpace / 100;

  const shading = document.getElementById('shading-percent')?.value || '';
  let shadingMultiplier = 1.0;
  if (shading === '0-10') shadingMultiplier = 1.0;
  else if (shading === '10-25') shadingMultiplier = 0.9;
  else if (shading === '25-50') shadingMultiplier = 0.75;
  else if (shading === '50+') shadingMultiplier = 0.6;

  let suggestedSize = Math.min(baseSize, spaceBasedSize || baseSize);
  suggestedSize = suggestedSize * shadingMultiplier;
  suggestedSize = Math.round(suggestedSize * 2) / 2;
  suggestedSize = Math.max(3.0, suggestedSize);

  let explanation = `Suggested System Size: ${suggestedSize} kW\n\n`;
  explanation += `CALCULATION BREAKDOWN:\n`;
  explanation += `‚Ä¢ Panel Capacity: ${panelAmps}A ‚Üí ${baseSize} kW max\n`;
  if (totalSpace > 0) explanation += `‚Ä¢ Available Space: ${Math.round(totalSpace)} sq ft ‚Üí ${spaceBasedSize.toFixed(1)} kW potential\n`;
  if (shading && shading !== '0-10') explanation += `‚Ä¢ Shading Impact: ${shading} ‚Üí ${(shadingMultiplier * 100).toFixed(0)}% efficiency\n`;
  explanation += `\nYou can adjust this number based on site needs.`;

  document.getElementById('system-size').value = suggestedSize;
  alert(explanation);
  updateProgress();
}

// ============================================
// Battery Toggle
// ============================================
document.getElementById('battery-included').addEventListener('change', function() {
  const batteryGroup = document.getElementById('battery-size-group');
  if (this.value === 'yes') batteryGroup.style.display = 'block';
  else {
    batteryGroup.style.display = 'none';
    document.getElementById('battery-size').value = '';
  }
  updateProgress();
});

// ============================================
// Mount Type Toggle
// ============================================
function toggleMountSection(type) {
  const roofSection = document.getElementById('roof-mount-section');
  const groundSection = document.getElementById('ground-mount-section');
  const roofGeneralInfo = document.getElementById('roof-general-info');
  const roofCheck = document.getElementById('mount-roof');
  const groundCheck = document.getElementById('mount-ground');

  if (type === 'roof') {
    roofSection.style.display = roofCheck.checked ? 'block' : 'none';
    roofGeneralInfo.style.display = roofCheck.checked ? 'block' : 'none';
  } else if (type === 'ground') {
    groundSection.style.display = groundCheck.checked ? 'block' : 'none';
  }
  updateProgress();
}

// ============================================
// Generate Roof Planes
// ============================================
function generateRoofPlanes() {
  const num = parseInt(document.getElementById('num-roof-planes').value);
  const container = document.getElementById('roof-planes-container');
  container.innerHTML = '';
  if (!num) return;

  for (let i = 1; i <= num; i++) {
    const planeDiv = document.createElement('div');
    planeDiv.style.cssText = 'background:#FFF8DC; padding:15px; margin:15px 0; border-radius:10px; border:2px solid #D2691E;';
    planeDiv.innerHTML = `
      <h4 style="color:#8B4513; margin-bottom:10px;">Mounting Plane ${i}</h4>

      <div class="form-group">
        <label>Direction/Orientation *</label>
        <select id="plane-${i}-direction">
          <option value="">Select direction</option>
          <option value="south">South (Best - 100%)</option>
          <option value="southwest">Southwest (Good - 90-95%)</option>
          <option value="southeast">Southeast (Good - 90-95%)</option>
          <option value="east">East (OK - 75-80%)</option>
          <option value="west">West (OK - 75-80%)</option>
          <option value="north">North (Avoid - Poor)</option>
        </select>
      </div>

      <div class="form-group">
        <label>Approximate Size *</label>
        <input type="text" id="plane-${i}-size" placeholder="e.g., 25ft x 15ft or 375 sq ft">
        <small>Length x Width or total square feet</small>
      </div>

      <div class="form-group">
        <label>Pitch/Slope</label>
        <select id="plane-${i}-pitch">
          <option value="">Select pitch</option>
          <option value="flat">Flat (0-2/12)</option>
          <option value="low">Low (3-4/12)</option>
          <option value="medium">Medium (5-7/12)</option>
          <option value="steep">Steep (8-12/12)</option>
          <option value="very-steep">Very Steep (&gt;12/12)</option>
        </select>
      </div>

      <div class="form-group">
        <label>Notes for MP ${i}</label>
        <textarea id="plane-${i}-notes" placeholder="Obstructions, shading, concerns..." style="min-height:60px;"></textarea>
      </div>
    `;
    container.appendChild(planeDiv);
  }
  updateProgress();
}

// ============================================
// UI Functions
// ============================================
function toggleSection(sectionId) {
  const content = document.getElementById('content-' + sectionId);
  content.classList.toggle('active');
}

function capturePhoto(type) {
  document.getElementById(type + '-input').click();
}

// ============================================
// Photo Handling
// ============================================
function handlePhotoUpload(event, type) {
  const files = event.target.files;
  if (!files || files.length === 0) return;

  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = function(e) {
      photos[type].push({
        data: e.target.result,
        name: file.name,
        timestamp: new Date().toISOString()
      });
      displayPhotos(type);
      updateProgress();
      updateConnectivityStatus(); // Update photo count warning
    };
    reader.readAsDataURL(file);
  });
}

function displayPhotos(type) {
  const gallery = document.getElementById(type + '-gallery');
  if (!gallery) return;
  
  gallery.innerHTML = '';

  photos[type].forEach((photo, index) => {
    const item = document.createElement('div');
    item.className = 'photo-item';
    item.innerHTML = `
      <img src="${photo.data}" alt="Photo ${index + 1}">
      <button class="photo-delete" onclick="deletePhoto('${type}', ${index})">√ó</button>
    `;
    gallery.appendChild(item);
  });
}

function deletePhoto(type, index) {
  photos[type].splice(index, 1);
  displayPhotos(type);
  updateProgress();
  updateConnectivityStatus(); // Update photo count warning
}

// ============================================
// Progress Tracking
// ============================================
function updateProgress() {
  let completed = 0;
  let total = 5;

  // Site info
  if (document.getElementById('site-name').value &&
      document.getElementById('tribal-affiliation').value &&
      document.getElementById('site-address').value &&
      document.getElementById('surveyor-name').value) {
    completed++;
    document.getElementById('status-site-info').textContent = 'Complete';
    document.getElementById('status-site-info').classList.add('complete');
  } else {
    document.getElementById('status-site-info').textContent = 'Incomplete';
    document.getElementById('status-site-info').classList.remove('complete');
  }

  // Roof info
  const roofChecked = document.getElementById('mount-roof').checked;
  const groundChecked = document.getElementById('mount-ground').checked;
  if ((roofChecked || groundChecked) && (!roofChecked || document.getElementById('roof-type').value)) {
    completed++;
    document.getElementById('status-roof-info').textContent = 'Complete';
    document.getElementById('status-roof-info').classList.add('complete');
  } else {
    document.getElementById('status-roof-info').textContent = 'Incomplete';
    document.getElementById('status-roof-info').classList.remove('complete');
  }

  // Electrical info
  if (photos['main-panel'].length > 0 && document.getElementById('panel-amperage').value) {
    completed++;
    document.getElementById('status-electrical-info').textContent = 'Complete';
    document.getElementById('status-electrical-info').classList.add('complete');
  } else {
    document.getElementById('status-electrical-info').textContent = 'Incomplete';
    document.getElementById('status-electrical-info').classList.remove('complete');
  }

  // Shading info
  if (photos['shading'].length > 0) {
    completed++;
    document.getElementById('status-shading-info').textContent = 'Complete';
    document.getElementById('status-shading-info').classList.add('complete');
  } else {
    document.getElementById('status-shading-info').textContent = 'Incomplete';
    document.getElementById('status-shading-info').classList.remove('complete');
  }

  // Optional sections
  if (photos['attic'].length > 0 || photos['meter'].length > 0 || photos['overview'].length > 0) {
    document.getElementById('status-additional-photos').textContent = 'Complete';
    document.getElementById('status-additional-photos').classList.add('complete');
  } else {
    document.getElementById('status-additional-photos').textContent = 'Optional';
    document.getElementById('status-additional-photos').classList.remove('complete');
  }

  if (document.getElementById('overall-assessment').value) {
    document.getElementById('status-final-notes').textContent = 'Complete';
    document.getElementById('status-final-notes').classList.add('complete');
  } else {
    document.getElementById('status-final-notes').textContent = 'Optional';
    document.getElementById('status-final-notes').classList.remove('complete');
  }

  const percent = Math.round((completed / total) * 100);
  document.getElementById('progress-fill').style.width = percent + '%';
  document.getElementById('progress-text').textContent = percent + '%';
}

// Add event listeners to all inputs
document.querySelectorAll('input, select, textarea').forEach(element => {
  element.addEventListener('change', updateProgress);
  element.addEventListener('input', updateProgress);
});

// ============================================
// Save & Export Functions
// ============================================
async function saveProgress() {
  const allData = { inputs: {}, photos: photos };

  document.querySelectorAll('input, select, textarea').forEach(element => {
    if (!element.id) return;
    if (element.type === 'checkbox') allData.inputs[element.id] = element.checked;
    else if (element.type !== 'file') allData.inputs[element.id] = element.value;
  });

  try {
    await saveToIndexedDB('solarSurvey', allData);
    const photoCount = getTotalPhotoCount();
    alert(`‚úÖ Progress saved! (${photoCount} photo${photoCount !== 1 ? 's' : ''} stored)\n\nYou can close and return later.`);
  } catch (e) {
    console.error('Save error:', e);
    alert('‚ùå Save failed. Please export the report instead to avoid data loss.');
  }
}

async function loadProgress() {
  const saved = await loadFromIndexedDB('solarSurvey');
  if (!saved) return;

  Object.keys(saved.inputs || {}).forEach(id => {
    const element = document.getElementById(id);
    if (!element) return;
    if (element.type === 'checkbox') element.checked = !!saved.inputs[id];
    else if (element.type !== 'file') element.value = saved.inputs[id];
  });

  Object.keys(saved.photos || {}).forEach(type => {
    photos[type] = saved.photos[type] || [];
    displayPhotos(type);
  });

  updateProgress();
  updateConnectivityStatus();
}

function generateReport() {
  const surveyData = {
    meta: {
      exportedAt: new Date().toISOString(),
      onlineAtExport: navigator.onLine
    },
    siteInfo: {
      siteName: document.getElementById('site-name').value,
      tribalAffiliation: document.getElementById('tribal-affiliation').value,
      siteAddress: document.getElementById('site-address').value,
      cityStateZip: document.getElementById('city-state-zip').value,
      gpsCoords: document.getElementById('gps-coords').value,
      surveyDate: document.getElementById('survey-date').value,
      surveyorName: document.getElementById('surveyor-name').value
    },
    roofInfo: {
      roofType: document.getElementById('roof-type')?.value || '',
      roofCondition: document.getElementById('roof-condition')?.value || '',
      roofAge: document.getElementById('roof-age')?.value || '',
      obstructions: {
        chimneys: document.getElementById('obstruction-chimneys').checked,
        vents: document.getElementById('obstruction-vents').checked,
        skylights: document.getElementById('obstruction-skylights').checked,
        trees: document.getElementById('obstruction-trees').checked
      },
      notes: document.getElementById('roof-notes').value,
      photosCount: photos['roof-mounting'].length
    },
    electricalInfo: {
      panelAmperage: document.getElementById('panel-amperage').value,
      mainBreaker: document.getElementById('main-breaker').value,
      availableSpaces: document.getElementById('available-spaces').value,
      notes: document.getElementById('electrical-notes').value,
      mainPanelPhotos: photos['main-panel'].length,
      panelLabelPhotos: photos['panel-label'].length,
      groundingPhotos: photos['grounding'].length
    },
    shadingInfo: {
      shadingPercent: document.getElementById('shading-percent').value,
      sources: {
        trees: document.getElementById('shade-trees').checked,
        buildings: document.getElementById('shade-buildings').checked,
        mountains: document.getElementById('shade-mountains').checked,
        none: document.getElementById('shade-none').checked
      },
      notes: document.getElementById('shading-notes').value,
      photosCount: photos['shading'].length
    },
    recommendations: {
      systemSizeKW: document.getElementById('system-size').value,
      batteryIncluded: document.getElementById('battery-included').value,
      batterySizeKWh: document.getElementById('battery-size').value,
      notes: document.getElementById('system-notes').value
    },
    summary: {
      overallAssessment: document.getElementById('overall-assessment').value,
      recommendedSize: document.getElementById('recommended-size').value,
      specialConsiderations: document.getElementById('special-considerations').value
    },
    uploadPrep: {
      readyForUpload: document.getElementById('ready-for-upload').checked,
      readyTimestamp: '',
      uploadNotes: document.getElementById('upload-notes').value
    },
    photos: photos,
    safetyDisclaimer: {
      acknowledged: safetyAcknowledged,
      acknowledgedAt: safetyAcknowledgedTimestamp,
      disclaimerText: "This survey form can be completed safely from the ground and outside electrical panels. DO NOT: Open electrical panels unless you are a licensed electrician. Climb on roofs unless you are trained and have proper fall protection PPE. Put yourself in any dangerous situation to complete this form. You are responsible for your own safety. Indigenized Energy is not liable for any injuries that occur during site surveys."
    }
  };

  const safeName = (surveyData.siteInfo.siteName || 'site').toString().trim().replace(/[^a-z0-9]+/gi, '_').replace(/^_+|_+$/g,'');
  const safeDate = (surveyData.siteInfo.surveyDate || '').toString().trim().replace(/\//g, '-') || new Date().toISOString().slice(0,10);
  const fileName = `SolarSurvey_${safeName}_${safeDate}.json`;

  const dataStr = JSON.stringify(surveyData, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);

  const link = document.createElement('a');
  link.href = url;
  link.download = fileName;
  link.click();

  const clearAfter = document.getElementById('clear-after-export');
  if (clearAfter && clearAfter.checked) {
    silentClearSurvey().then(() => {
      const photoCount = getTotalPhotoCount();
      alert(`‚úÖ Survey report generated!\nüìÅ File downloaded: ${fileName}\nüóëÔ∏è Form cleared`);
    });
  } else {
    alert(`‚úÖ Survey report generated!\nüìÅ File downloaded: ${fileName}`);
  }
}

async function clearSurvey() {
  if (confirm('Are you sure you want to clear all survey data? This cannot be undone.')) {
    await silentClearSurvey();
    alert('Survey cleared!');
  }
}

async function silentClearSurvey() {
  document.querySelectorAll('input, select, textarea').forEach(element => {
    if (element.type === 'checkbox') element.checked = false;
    else if (element.type !== 'file') element.value = '';
  });

  Object.keys(photos).forEach(type => {
    photos[type] = [];
    displayPhotos(type);
  });

  await deleteFromIndexedDB('solarSurvey');
  await deleteFromIndexedDB('solarSurveyReadyTimestamp');

  document.getElementById('survey-date').value = new Date().toLocaleDateString();
  
  // Reset ready checkbox
  const readyBox = document.getElementById('ready-for-upload');
  const readyTs = document.getElementById('ready-timestamp');
  if (readyBox) readyBox.checked = false;
  if (readyTs) readyTs.textContent = '';
  
  updateProgress();
  updateConnectivityStatus();
}
</script>
</body>
</html>



